# 多种服务端构建方式性能及内存开销对比



## 压测条件

- jvm参数

  > -Xmx512m -Xms512m -XX:-UseAdaptiveSizePolicy

- 压测命令

  > wrk -c 30 -d 20 http://localhost:port



## 场景

### 单线程

- 堆内存信息

  ```
   S0C    S1C    S0U    S1U      EC       EU        OC         OU       MC     MU    CCSC   CCSU   YGC     YGCT    FGC    FGCT     GCT   
  21504.0 21504.0  0.0    0.0   131584.0  7895.1   349696.0     0.0     4480.0 790.7  384.0   76.4       0    0.000   0      0.000    0.000
  21504.0 21504.0  0.0    0.0   131584.0  7895.1   349696.0     0.0     4480.0 790.7  384.0   76.4       0    0.000   0      0.000    0.000
  21504.0 21504.0  0.0    0.0   131584.0  7895.1   349696.0     0.0     4480.0 790.7  384.0   76.4       0    0.000   0      0.000    0.000
  21504.0 21504.0 2928.0  0.0   131584.0 43221.4   349696.0     16.0    4864.0 3298.5 512.0  339.5       2    0.012   0      0.000    0.012
  21504.0 21504.0 3008.0  0.0   131584.0 18464.9   349696.0     24.0    4864.0 3298.6 512.0  339.5       6    0.035   0      0.000    0.035
  21504.0 21504.0  0.0   3040.0 131584.0 63338.1   349696.0     24.0    4864.0 3298.6 512.0  339.5       9    0.049   0      0.000    0.049
  21504.0 21504.0  0.0   3056.0 131584.0 97646.8   349696.0     32.0    4864.0 3301.9 512.0  339.5      13    0.069   0      0.000    0.069
  21504.0 21504.0  0.0   2528.0 131584.0 60699.5   349696.0    540.1    4864.0 3301.9 512.0  339.5      17    0.087   0      0.000    0.087
  21504.0 21504.0  0.0   2560.0 131584.0 84451.5   349696.0    540.1    4864.0 3301.9 512.0  339.5      21    0.105   0      0.000    0.105
  21504.0 21504.0 2528.0  0.0   131584.0 81821.6   349696.0    540.1    4864.0 3301.9 512.0  339.5      24    0.118   0      0.000    0.118
  21504.0 21504.0 2528.0  0.0   131584.0 81821.6   349696.0    540.1    4864.0 3301.9 512.0  339.5      28    0.134   0      0.000    0.134
  21504.0 21504.0  0.0   2528.0 131584.0 81812.4   349696.0    540.1    4864.0 3301.9 512.0  339.5      31    0.148   0      0.000    0.148
  21504.0 21504.0  0.0   2560.0 131584.0  5278.2   349696.0    540.1    4864.0 3301.9 512.0  339.5      35    0.166   0      0.000    0.166
  21504.0 21504.0  0.0   2528.0 131584.0 18473.8   349696.0    540.1    4864.0 3301.9 512.0  339.5      39    0.184   0      0.000    0.184
  21504.0 21504.0 2528.0  0.0   131584.0 60708.4   349696.0    540.1    4864.0 3301.9 512.0  339.5      42    0.197   0      0.000    0.197
  21504.0 21504.0 2560.0  0.0   131584.0 87099.9   349696.0    540.1    4864.0 3301.9 512.0  339.5      46    0.217   0      0.000    0.217
  21504.0 21504.0 2560.0  0.0   131584.0 44873.5   349696.0    540.1    4864.0 3301.9 512.0  339.5      50    0.233   0      0.000    0.233
  21504.0 21504.0 2496.0  0.0   131584.0 47512.7   349696.0    540.1    4864.0 3301.9 512.0  339.5      54    0.251   0      0.000    0.251
  21504.0 21504.0  0.0   2560.0 131584.0 31669.3   349696.0    540.1    4864.0 3301.9 512.0  339.5      57    0.263   0      0.000    0.263
  21504.0 21504.0  0.0   2560.0 131584.0 23752.0   349696.0    540.1    4864.0 3301.9 512.0  339.5      61    0.281   0      0.000    0.281
  21504.0 21504.0 2560.0  0.0   131584.0 26399.5   349696.0    540.1    4864.0 3301.9 512.0  339.5      64    0.293   0      0.000    0.293
  21504.0 21504.0 2560.0  0.0   131584.0 39595.2   349696.0    540.1    4864.0 3301.9 512.0  339.5      68    0.309   0      0.000    0.309
  21504.0 21504.0  0.0   2560.0 131584.0  5278.2   349696.0    540.1    4864.0 3301.9 512.0  339.5      71    0.322   0      0.000    0.322
  21504.0 21504.0 2560.0  0.0   131584.0 116130.5  349696.0    540.1    4864.0 3301.9 512.0  339.5      72    0.326   0      0.000    0.326
  21504.0 21504.0 2560.0  0.0   131584.0 116130.5  349696.0    540.1    4864.0 3301.9 512.0  339.5      72    0.326   0      0.000    0.326
  ```

- 压测结果

  ```
  Running 20s test @ http://localhost:8801
    2 threads and 30 connections
    Thread Stats   Avg      Stdev     Max   +/- Stdev
      Latency     2.26ms   16.79ms 293.40ms   98.86%
      Req/Sec     2.57k   782.09     3.82k    83.91%
    97967 requests in 20.06s, 12.84MB read
    Socket errors: connect 0, read 373689, write 49, timeout 0
  Requests/sec:   4883.98
  Transfer/sec:    655.66KB
  ```

  

### 多线程 

- 堆内存信息

  ```
   S0C    S1C    S0U    S1U      EC       EU        OC         OU       MC     MU    CCSC   CCSU   YGC     YGCT    FGC    FGCT     GCT   
  21504.0 21504.0  0.0    0.0   131584.0 13158.9   349696.0     0.0     4480.0 779.9  384.0   76.4       0    0.000   0      0.000    0.000
  21504.0 21504.0  0.0    0.0   131584.0 13158.9   349696.0     0.0     4480.0 779.9  384.0   76.4       0    0.000   0      0.000    0.000
  21504.0 21504.0 256.0   0.0   131584.0   0.0     349696.0    1226.8   4992.0 4648.3 640.0  508.1      28    0.021   0      0.000    0.021
  21504.0 21504.0 192.0   0.0   131584.0   0.0     349696.0    1386.8   4992.0 4649.7 640.0  509.1     246    0.109   0      0.000    0.109
  21504.0 21504.0  0.0   160.0  131584.0   0.0     349696.0    1386.8   4992.0 4649.7 640.0  509.1     511    0.212   0      0.000    0.212
  21504.0 21504.0 160.0   0.0   131584.0   0.0     349696.0    1386.8   4992.0 4649.7 640.0  509.1     794    0.324   0      0.000    0.324
  21504.0 21504.0  0.0   192.0  131584.0   0.0     349696.0    1386.8   4992.0 4650.1 640.0  509.1    1033    0.417   0      0.000    0.417
  21504.0 21504.0  0.0   160.0  131584.0   0.0     349696.0    1386.8   4992.0 4653.1 640.0  509.1    1315    0.529   0      0.000    0.529
  21504.0 21504.0  0.0   192.0  131584.0 68452.1   349696.0    1386.8   4992.0 4653.1 640.0  509.1    1557    0.626   0      0.000    0.626
  21504.0 21504.0 160.0   0.0   131584.0   0.0     349696.0    1386.8   4992.0 4653.1 640.0  509.1    1842    0.738   0      0.000    0.738
  21504.0 21504.0 224.0   0.0   131584.0   0.0     349696.0    1386.8   4992.0 4653.1 640.0  509.1    2105    0.839   0      0.000    0.839
  21504.0 21504.0  0.0   160.0  131584.0   0.0     349696.0    1386.8   4992.0 4653.1 640.0  509.1    2387    0.949   0      0.000    0.949
  21504.0 21504.0  0.0   224.0  131584.0   0.0     349696.0    1386.8   4992.0 4653.1 640.0  509.1    2620    1.041   0      0.000    1.041
  21504.0 21504.0  0.0   256.0  131584.0   0.0     349696.0    1386.8   4992.0 4653.1 640.0  509.1    2883    1.145   0      0.000    1.145
  21504.0 21504.0 192.0   0.0   131584.0   0.0     349696.0    1386.8   4992.0 4653.1 640.0  509.1    3182    1.262   0      0.000    1.262
  21504.0 21504.0 128.0   0.0   131584.0 42126.5   349696.0    1386.8   4992.0 4653.1 640.0  509.1    3414    1.354   0      0.000    1.354
  21504.0 21504.0 160.0   0.0   131584.0   0.0     349696.0    1386.8   4992.0 4653.1 640.0  509.1    3684    1.458   0      0.000    1.458
  21504.0 21504.0  0.0   160.0  131584.0   0.0     349696.0    1386.8   4992.0 4653.1 640.0  509.1    3951    1.563   0      0.000    1.563
  21504.0 21504.0  0.0   224.0  131584.0   0.0     349696.0    1386.8   4992.0 4653.1 640.0  509.1    4246    1.678   0      0.000    1.678
  21504.0 21504.0 160.0   0.0   131584.0   0.0     349696.0    1386.8   4992.0 4653.1 640.0  509.1    4474    1.769   0      0.000    1.769
  21504.0 21504.0  0.0   160.0  131584.0   0.0     349696.0    1386.8   4992.0 4653.1 640.0  509.1    4769    1.886   0      0.000    1.886
  21504.0 21504.0 192.0   0.0   131584.0 92148.1   349696.0    1386.8   4992.0 4653.1 640.0  509.1    5030    1.991   0      0.000    1.991
  21504.0 21504.0  0.0   128.0  131584.0 63186.6   349696.0    1386.8   4992.0 4653.1 640.0  509.1    5167    2.046   0      0.000    2.046
  21504.0 21504.0  0.0   128.0  131584.0 63186.6   349696.0    1386.8   4992.0 4653.1 640.0  509.1    5167    2.046   0      0.000    2.046
  21504.0 21504.0  0.0   128.0  131584.0 63186.6   349696.0    1386.8   4992.0 4653.1 640.0  509.1    5167    2.046   0      0.000    2.046
  ```

  

- 压测结果

  ```
  Running 20s test @ http://localhost:8802
    2 threads and 30 connections
    Thread Stats   Avg      Stdev     Max   +/- Stdev
      Latency     2.05ms    3.86ms 190.78ms   99.73%
      Req/Sec   353.43    130.17   740.00     68.15%
    13678 requests in 20.09s, 6.01MB read
    Socket errors: connect 0, read 276594, write 20, timeout 0
  Requests/sec:    680.80
  Transfer/sec:    306.31KB	
  ```

  

### 使用线程池管理线程

- 堆内存信息

  ```
   S0C    S1C    S0U    S1U      EC       EU        OC         OU       MC     MU    CCSC   CCSU   YGC     YGCT    FGC    FGCT     GCT   
  21504.0 21504.0  0.0    0.0   131584.0  7895.1   349696.0     0.0     4480.0 790.7  384.0   76.4       0    0.000   0      0.000    0.000
  21504.0 21504.0  0.0    0.0   131584.0  7895.1   349696.0     0.0     4480.0 790.7  384.0   76.4       0    0.000   0      0.000    0.000
  21504.0 21504.0  0.0   2986.0 131584.0 63276.5   349696.0     8.0     4992.0 4404.8 640.0  469.8       1    0.005   0      0.000    0.005
  21504.0 21504.0  0.0   3200.0 131584.0 86085.8   349696.0     40.0    4992.0 4414.3 640.0  470.8       5    0.024   0      0.000    0.024
  21504.0 21504.0  0.0   3168.0 131584.0 110981.7  349696.0     40.0    4992.0 4414.3 640.0  470.8       9    0.045   0      0.000    0.045
  21504.0 21504.0  0.0   3168.0 131584.0 16147.2   349696.0     48.0    4992.0 4422.1 640.0  470.8      13    0.065   0      0.000    0.065
  21504.0 21504.0  0.0   2592.0 131584.0  2633.2   349696.0    790.9    4992.0 4423.8 640.0  470.8      17    0.082   0      0.000    0.082
  21504.0 21504.0  0.0   2560.0 131584.0  5833.6   349696.0    790.9    4992.0 4423.8 640.0  470.8      21    0.097   0      0.000    0.097
  21504.0 21504.0 2592.0  0.0   131584.0 110100.0  349696.0    790.9    4992.0 4423.8 640.0  470.8      24    0.109   0      0.000    0.109
  21504.0 21504.0  0.0   2624.0 131584.0 125994.6  349696.0    790.9    4992.0 4423.8 640.0  470.8      27    0.123   0      0.000    0.123
  21504.0 21504.0  0.0   2624.0 131584.0 64499.8   349696.0    790.9    4992.0 4423.8 640.0  470.8      31    0.141   0      0.000    0.141
  21504.0 21504.0  0.0   2624.0 131584.0 64893.9   349696.0    790.9    4992.0 4423.8 640.0  470.8      35    0.157   0      0.000    0.157
  21504.0 21504.0 2560.0  0.0   131584.0 56813.5   349696.0    790.9    4992.0 4423.8 640.0  470.8      38    0.170   0      0.000    0.170
  21504.0 21504.0 2592.0  0.0   131584.0 72526.4   349696.0    790.9    4992.0 4423.8 640.0  470.8      42    0.185   0      0.000    0.185
  21504.0 21504.0 2592.0  0.0   131584.0 43710.8   349696.0    790.9    4992.0 4423.8 640.0  470.8      46    0.201   0      0.000    0.201
  21504.0 21504.0  0.0   2656.0 131584.0   0.0     349696.0    790.9    4992.0 4423.8 640.0  470.8      49    0.213   0      0.000    0.213
  21504.0 21504.0 2560.0  0.0   131584.0 92946.9   349696.0    790.9    4992.0 4423.8 640.0  470.8      52    0.226   0      0.000    0.226
  21504.0 21504.0  0.0   2560.0 131584.0 65673.0   349696.0    790.9    4992.0 4423.8 640.0  470.8      55    0.241   0      0.000    0.241
  21504.0 21504.0  0.0   2560.0 131584.0 97172.0   349696.0    790.9    4992.0 4423.8 640.0  470.8      59    0.257   0      0.000    0.257
  21504.0 21504.0 2624.0  0.0   131584.0 53151.1   349696.0    790.9    4992.0 4423.8 640.0  470.8      62    0.269   0      0.000    0.269
  21504.0 21504.0 2624.0  0.0   131584.0 114606.0  349696.0    790.9    4992.0 4423.8 640.0  470.8      66    0.285   0      0.000    0.285
  21504.0 21504.0 2592.0  0.0   131584.0 98484.2   349696.0    790.9    4992.0 4423.8 640.0  470.8      70    0.300   0      0.000    0.300
  21504.0 21504.0 2656.0  0.0   131584.0 79189.9   349696.0    790.9    4992.0 4423.8 640.0  470.8      72    0.308   0      0.000    0.308
  21504.0 21504.0 2656.0  0.0   131584.0 79189.9   349696.0    790.9    4992.0 4423.8 640.0  470.8      72    0.308   0      0.000    0.308
  21504.0 21504.0 2656.0  0.0   131584.0 79189.9   349696.0    790.9    4992.0 4423.8 640.0  470.8      72    0.308   0      0.000    0.308
  ```

  

- 压测结果

  ```
  Running 20s test @ http://localhost:8803
    2 threads and 30 connections
    Thread Stats   Avg      Stdev     Max   +/- Stdev
      Latency     1.61ms   12.99ms 324.68ms   99.24%
      Req/Sec     1.77k   679.66     3.21k    72.70%
    66059 requests in 20.09s, 10.22MB read
    Socket errors: connect 0, read 365203, write 26, timeout 0
  Requests/sec:   3288.15
  Transfer/sec:    521.04KB
  ```

  

### Netty

- 堆内存信息

  ```
   S0C    S1C    S0U    S1U      EC       EU        OC         OU       MC     MU    CCSC   CCSU   YGC     YGCT    FGC    FGCT     GCT   
  21504.0 21504.0  0.0    0.0   131584.0 28953.4   349696.0     0.0     4480.0 779.9  384.0   76.4       0    0.000   0      0.000    0.000
  21504.0 21504.0  0.0    0.0   131584.0 28953.4   349696.0     0.0     4480.0 779.9  384.0   76.4       0    0.000   0      0.000    0.000
  21504.0 21504.0  0.0    0.0   131584.0 28953.4   349696.0     0.0     4480.0 779.9  384.0   76.4       0    0.000   0      0.000    0.000
  21504.0 21504.0  0.0    0.0   131584.0 31585.1   349696.0     0.0     4480.0 779.9  384.0   76.4       0    0.000   0      0.000    0.000
  21504.0 21504.0  0.0   9031.4 131584.0 63529.8   349696.0     16.0    11136.0 10673.8 1408.0 1235.6      1    0.006   0      0.000    0.006
  21504.0 21504.0 6272.0  0.0   131584.0 130648.0  349696.0     24.0    11136.0 10701.7 1408.0 1236.1      2    0.009   0      0.000    0.009
  21504.0 21504.0 6176.0  0.0   131584.0 73548.8   349696.0     40.0    11136.0 10702.3 1408.0 1236.1      4    0.014   0      0.000    0.014
  21504.0 21504.0 6240.0  0.0   131584.0  9186.2   349696.0     48.0    11136.0 10702.3 1408.0 1236.1      6    0.020   0      0.000    0.020
  21504.0 21504.0  0.0   6208.0 131584.0 78235.0   349696.0     56.0    11136.0 10702.3 1408.0 1236.1      7    0.022   0      0.000    0.022
  21504.0 21504.0  0.0   6192.0 131584.0 11959.7   349696.0     56.0    11136.0 10702.3 1408.0 1236.1      9    0.027   0      0.000    0.027
  21504.0 21504.0 6240.0  0.0   131584.0 81659.1   349696.0     56.0    11136.0 10702.3 1408.0 1236.1     10    0.029   0      0.000    0.029
  21504.0 21504.0 6208.0  0.0   131584.0  3325.5   349696.0     56.0    11136.0 10702.3 1408.0 1236.1     12    0.035   0      0.000    0.035
  21504.0 21504.0  0.0   6240.0 131584.0 59846.5   349696.0     56.0    11136.0 10702.3 1408.0 1236.1     13    0.037   0      0.000    0.037
  21504.0 21504.0 6208.0  0.0   131584.0 111605.4  349696.0     56.0    11136.0 10702.3 1408.0 1236.1     14    0.040   0      0.000    0.040
  21504.0 21504.0 320.0   0.0   131584.0 34207.1   349696.0    6513.4   11136.0 10702.3 1408.0 1236.1     16    0.046   0      0.000    0.046
  21504.0 21504.0  0.0   160.0  131584.0 91914.4   349696.0    6561.4   11136.0 10702.3 1408.0 1236.1     17    0.047   0      0.000    0.047
  21504.0 21504.0  0.0   224.0  131584.0 13099.0   349696.0    6561.4   11136.0 10702.3 1408.0 1236.1     19    0.048   0      0.000    0.048
  21504.0 21504.0 160.0   0.0   131584.0 70504.6   349696.0    6561.4   11136.0 10702.3 1408.0 1236.1     20    0.048   0      0.000    0.048
  21504.0 21504.0  0.0   192.0  131584.0 117660.0  349696.0    6585.4   11136.0 10702.3 1408.0 1236.1     21    0.049   0      0.000    0.049
  21504.0 21504.0  0.0    96.0  131584.0 45928.1   349696.0    6585.4   11136.0 10702.3 1408.0 1236.1     23    0.050   0      0.000    0.050
  21504.0 21504.0 128.0   0.0   131584.0 99685.2   349696.0    6585.4   11136.0 10702.3 1408.0 1236.1     24    0.051   0      0.000    0.051
  21504.0 21504.0  96.0   0.0   131584.0 18291.6   349696.0    6585.4   11136.0 10702.3 1408.0 1236.1     26    0.052   0      0.000    0.052
  21504.0 21504.0  0.0    96.0  131584.0 74846.2   349696.0    6625.4   11136.0 10702.3 1408.0 1236.1     27    0.053   0      0.000    0.053
  21504.0 21504.0 192.0   0.0   131584.0 109818.4  349696.0    6625.4   11136.0 10702.3 1408.0 1236.1     28    0.053   0      0.000    0.053
  21504.0 21504.0 192.0   0.0   131584.0 109818.4  349696.0    6625.4   11136.0 10702.3 1408.0 1236.1     28    0.053   0      0.000    0.053
  21504.0 21504.0 192.0   0.0   131584.0 109818.4  349696.0    6625.4   11136.0 10702.3 1408.0 1236.1     28    0.053   0      0.000    0.053
  ```

  

- 压测结果

  ```
  Running 20s test @ http://localhost:8808
    2 threads and 30 connections
    Thread Stats   Avg      Stdev     Max   +/- Stdev
      Latency     1.02ms    9.67ms 189.89ms   99.11%
      Req/Sec    59.56k     6.74k   69.40k    95.98%
    2358807 requests in 20.00s, 240.70MB read
  Requests/sec: 117914.52
  Transfer/sec:     12.03MB
  ```

  

## 分析

- 对比对内存信息可以发现
  - 多线程构建的服务端,因为每次都要创建一个线程栈,线程栈默认1M,所以Eden区快速增长,,Young GC的频率最高,导致的Young GC耗时自然也是最长的
  - 使用线程池管理后,Eden区增长速度明显下降,Young GC频率也明显下降,GC耗时明显减少
  - Netty构建的服务端,明显可以看出Young GC 发生的次数最少,耗费的时间最短

- 对比压测结果
  - 在本次的测试用例中,由于每次请求处理的时间非常短,可以发现压测结果中单线程构建的服务端性能并不差,甚至好于多线程和线程池,因为在这个请求过程中处理时间远远小于线程上下文切换或者创建线程带来的耗时
  - 对比多线程和使用线程池,可以发现使用线程池后,由于减少了线程上下文的切换和创建线程带来的开销,QPS和吞吐量明显的到了提升
  - Netty 的吞吐量和QPS是压测中表现最好的,因为Netty使用了IO多路复用,所以不会被阻塞在等待内核数据的过程,且Netty使用了零拷贝技术,所以也不会为了将数据从内核复制到用户空间而花费额外的时间