# 本机java程序使用G1 GC 内存分析



## 启动参数

>java -XX:+UseG1GC -XX:-UseAdaptiveSizePolicy -Xms1g -Xmx1g -XX:MaxGCPauseMillis=50  -jar  gateway-server-0.0.1-SDDNAPSHOT.jar



## 压测条件

> 使用jmeter 15个线程并发请求300s

## jmap -heap -pid

###  压测前

```
Attaching to process ID 6312, please wait...
Debugger attached successfully.
Server compiler detected.
JVM version is 25.291-b10

using thread-local object allocation.
Garbage-First (G1) GC with 8 thread(s)  //使用8个GC线程

Heap Configuration://堆配置
   MinHeapFreeRatio         = 40  //空闲堆空间的最小百分比
   MaxHeapFreeRatio         = 70   //空闲堆空间的最大百分比
   MaxHeapSize              = 1073741824 (1024.0MB)  //堆最大内存大小
   NewSize                  = 1363144 (1.2999954223632812MB) //年轻代大小
   MaxNewSize               = 643825664 (614.0MB) //年轻代最大堆内存大小
   OldSize                  = 5452592 (5.1999969482421875MB) //老年代大小
   NewRatio                 = 2          //默认年轻代和老年代的比例
   SurvivorRatio            = 8           //survivor 区和eden区比例
   MetaspaceSize            = 21807104 (20.796875MB) //元空间大小
   CompressedClassSpaceSize = 1073741824 (1024.0MB)  //压缩类空间大小
   MaxMetaspaceSize         = 17592186044415 MB     //元空间最大大小
   G1HeapRegionSize         = 1048576 (1.0MB)         //G1 单个Region大小1MB

Heap Usage:
G1 Heap:
   regions  = 1024      //region 个数:1024个,因为每个1M,堆内存大小1024MB
   capacity = 1073741824 (1024.0MB)  //堆内存大小
   used     = 40774128 (38.88523864746094MB) //已经使用的堆内存
   free     = 1032967696 (985.1147613525391MB) //空闲堆内存
   3.797386586666107% used  //堆内存使用率
G1 Young Generation:    //年轻代
Eden Space:
   regions  = 15    //使用了15个region
   capacity = 235929600 (225.0MB)  //占用225MB
   used     = 15728640 (15.0MB)  //当前使用了15MB
   free     = 220200960 (210.0MB)  //空闲空间210MB
   6.666666666666667% used   //使用率
Survivor Space:
   regions  = 21  //幸存区使用了21个
   capacity = 22020096 (21.0MB) //占用21MB
   used     = 22020096 (21.0MB) //使用了21MB
   free     = 0 (0.0MB)  //空闲0MB
   100.0% used     //使用率100%
G1 Old Generation:     //老年代
   regions  = 3      //使用了3个region
   capacity = 815792128 (778.0MB) //占用778M
   used     = 1976816 (1.8852386474609375MB)  //使用了1.88MB
   free     = 813815312 (776.1147613525391MB)  // 空闲776MB
   0.2423185922186295% used  //使用率

16573 interned Strings occupying 2221304 bytes.

```

### 压测启动后

```
Attaching to process ID 6312, please wait...
Debugger attached successfully.
Server compiler detected.
JVM version is 25.291-b10

using thread-local object allocation.
Garbage-First (G1) GC with 8 thread(s)

Heap Configuration:
   MinHeapFreeRatio         = 40
   MaxHeapFreeRatio         = 70
   MaxHeapSize              = 1073741824 (1024.0MB)
   NewSize                  = 1363144 (1.2999954223632812MB)
   MaxNewSize               = 643825664 (614.0MB)
   OldSize                  = 5452592 (5.1999969482421875MB)
   NewRatio                 = 2
   SurvivorRatio            = 8
   MetaspaceSize            = 21807104 (20.796875MB)
   CompressedClassSpaceSize = 1073741824 (1024.0MB)
   MaxMetaspaceSize         = 17592186044415 MB
   G1HeapRegionSize         = 1048576 (1.0MB)

Heap Usage:
G1 Heap:
   regions  = 1024
   capacity = 1073741824 (1024.0MB)
   used     = 522759472 (498.5422821044922MB)
   free     = 550982352 (525.4577178955078MB)
   48.685769736766815% used
G1 Young Generation:
Eden Space:
   regions  = 471
   capacity = 675282944 (644.0MB)
   used     = 493879296 (471.0MB)
   free     = 181403648 (173.0MB)
   73.13664596273291% used
Survivor Space:
   regions  = 1
   capacity = 1048576 (1.0MB)
   used     = 1048576 (1.0MB)
   free     = 0 (0.0MB)
   100.0% used
G1 Old Generation:
   regions  = 28
   capacity = 397410304 (379.0MB)
   used     = 27831600 (26.542282104492188MB)
   free     = 369578704 (352.4577178955078MB)
   7.003240660815881% used

```

- 每个分区使用的Region个数在变化,相应的堆内存空间也在变化,说明G1会根据运行的情况动态调整各分区使用的Region

  - Survivor空间明显减少,说明每次Young GC 存活的对象很少

  - Eden 空间明显增大,说明有大量对象创建

    



## jstat -gc -pid 1000 1000

### 压测前

```
 S0C    S1C    S0U    S1U      EC       EU        OC         OU       MC     MU    CCSC   CCSU   YGC     YGCT    FGC    FGCT     GCT
 0.0   24576.0  0.0   24576.0 142336.0 77824.0   881664.0    3175.0   33916.0 32251.1 4528.0 4173.0      6    0.043   0      0.000    0.043
 0.0   24576.0  0.0   24576.0 142336.0 77824.0   881664.0    3175.0   33916.0 32251.1 4528.0 4173.0      6    0.043   0      0.000    0.043
 0.0   24576.0  0.0   24576.0 142336.0 77824.0   881664.0    3175.0   33916.0 32251.1 4528.0 4173.0      6    0.043   0      0.000    0.043
 0.0   24576.0  0.0   24576.0 142336.0 77824.0   881664.0    3175.0   33916.0 32251.1 4528.0 4173.0      6    0.043   0      0.000    0.043
 0.0   24576.0  0.0   24576.0 142336.0 77824.0   881664.0    3175.0   33916.0 32251.1 4528.0 4173.0      6    0.043   0      0.000    0.043
 0.0   24576.0  0.0   24576.0 142336.0 77824.0   881664.0    3175.0   33916.0 32251.1 4528.0 4173.0      6    0.043   0      0.000    0.043

```

- 此时由于还没有请求,没有新对象产生,各个分区堆内存占用保持不变

### 压测启动后

```
S0C    S1C    S0U    S1U      EC       EU        OC         OU       MC     MU    CCSC   CCSU   YGC     YGCT    FGC    FGCT     GCT
 0.0   21504.0  0.0   21504.0 154624.0 128000.0  872448.0    2625.0   33020.0 31528.5 4400.0 4084.2      6    0.037   0      0.000    0.037
 0.0   21504.0  0.0   21504.0 154624.0 128000.0  872448.0    2625.0   33020.0 31528.5 4400.0 4084.2      6    0.037   0      0.000    0.037
 0.0   21504.0  0.0   21504.0 154624.0 129024.0  872448.0    2625.0   33020.0 31528.5 4400.0 4084.2      6    0.037   0      0.000    0.037
 0.0   21504.0  0.0   21504.0 154624.0 129024.0  872448.0    2625.0   33020.0 31528.5 4400.0 4084.2      6    0.037   0      0.000    0.037
 0.0   21504.0  0.0   21504.0 154624.0 129024.0  872448.0    2625.0   33020.0 31528.5 4400.0 4084.2      6    0.037   0      0.000    0.037
 0.0   21504.0  0.0   21504.0 154624.0 129024.0  872448.0    2625.0   33020.0 31528.5 4400.0 4084.2      6    0.037   0      0.000    0.037
 0.0   21504.0  0.0   21504.0 154624.0 129024.0  872448.0    2625.0   33020.0 31528.5 4400.0 4084.2      6    0.037   0      0.000    0.037
 0.0   21504.0  0.0   21504.0 154624.0 140288.0  872448.0    2625.0   33020.0 31528.5 4400.0 4084.2      6    0.037   0      0.000    0.037
 0.0   7168.0  0.0   7168.0 441344.0 33792.0   600064.0   14168.0   37960.0 36030.2 4988.0 4552.9      8    0.052   0      0.000    0.052
 0.0   7168.0  0.0   7168.0 441344.0 250880.0  600064.0   14168.0   37960.0 36030.2 4988.0 4552.9      8    0.052   0      0.000    0.052
 0.0   8192.0  0.0   8192.0 652288.0 120832.0  388096.0   14168.0   38216.0 36243.7 4988.0 4553.9      9    0.058   0      0.000    0.058
 0.0   8192.0  0.0   8192.0 652288.0 409600.0  388096.0   14168.0   38216.0 36243.7 4988.0 4553.9      9    0.058   0      0.000    0.058
 0.0   8192.0  0.0   8192.0 652288.0 176128.0  388096.0   14168.0   38216.0 36300.8 4988.0 4558.4     10    0.061   0      0.000    0.061
 0.0   8192.0  0.0   8192.0 652288.0 22528.0   388096.0   14680.0   38216.0 36326.6 4988.0 4561.3     11    0.065   0      0.000    0.065
 0.0   8192.0  0.0   8192.0 652288.0 527360.0  388096.0   14680.0   38216.0 36326.6 4988.0 4561.3     11    0.065   0      0.000    0.065
 0.0   7168.0  0.0   7168.0 653312.0 423936.0  388096.0   14168.0   38216.0 36326.6 4988.0 4561.3     12    0.068   0      0.000    0.068
 0.0   8192.0  0.0   8192.0 652288.0 297984.0  388096.0   14168.0   38216.0 36328.9 4988.0 4561.3     13    0.071   0      0.000    0.071
 0.0   7168.0  0.0   7168.0 653312.0 108544.0  388096.0   14168.0   38216.0 36328.9 4988.0 4561.3     14    0.074   0      0.000    0.074
 0.0   7168.0  0.0   7168.0 653312.0 28672.0   388096.0   14680.0   38216.0 36328.9 4988.0 4561.3     15    0.077   0      0.000    0.077
 0.0   7168.0  0.0   7168.0 653312.0 457728.0  388096.0   14680.0   38216.0 36328.9 4988.0 4561.3     15    0.077   0      0.000    0.077
 0.0   7168.0  0.0   7168.0 653312.0 324608.0  388096.0   14168.0   38216.0 36328.9 4988.0 4561.3     16    0.080   0      0.000    0.080
 0.0   7168.0  0.0   7168.0 653312.0 176128.0  388096.0   14168.0   38216.0 36328.9 4988.0 4561.3     17    0.084   0      0.000    0.084
 0.0   7168.0  0.0   7168.0 653312.0 40960.0   388096.0   14680.0   38216.0 36330.8 4988.0 4561.3     18    0.087   0      0.000    0.087
 0.0   7168.0  0.0   7168.0 653312.0 547840.0  388096.0   14680.0   38216.0 36330.8 4988.0 4561.3     18    0.087   0      0.000    0.087
 0.0   7168.0  0.0   7168.0 653312.0 424960.0  388096.0   14680.0   38216.0 36331.1 4988.0 4561.3     19    0.090   0      0.000    0.090
 0.0   6144.0  0.0   6144.0 654336.0 240640.0  388096.0   14680.0   38216.0 36331.1 4988.0 4561.3     20    0.093   0      0.000    0.093
 0.0   7168.0  0.0   7168.0 653312.0 155648.0  388096.0   14680.0   38216.0 36331.9 4988.0 4561.3     21    0.096   0      0.000    0.096
 0.0   5120.0  0.0   5120.0 655360.0 13312.0   388096.0   16865.5   38216.0 36332.4 4988.0 4561.3     22    0.100   0      0.000    0.100
 0.0   5120.0  0.0   5120.0 655360.0 520192.0  388096.0   16865.5   38216.0 36332.4 4988.0 4561.3     22    0.100   0      0.000    0.100
 0.0   3072.0  0.0   3072.0 657408.0 375808.0  388096.0   20120.4   38216.0 36337.5 4988.0 4561.3     23    0.103   0      0.000    0.103
 0.0   1024.0  0.0   1024.0 659456.0 266240.0  388096.0   21362.2   38216.0 36338.2 4988.0 4561.8     24    0.104   0      0.000    0.104
 0.0   1024.0  0.0   1024.0 659456.0 130048.0  388096.0   21705.3   38216.0 36338.2 4988.0 4561.8     25    0.106   0      0.000    0.106
 0.0   1024.0  0.0   1024.0 659456.0 10240.0   388096.0   21743.3   38216.0 36338.2 4988.0 4561.8     26    0.107   0      0.000    0.107
 0.0   1024.0  0.0   1024.0 659456.0 556032.0  388096.0   21743.3   38216.0 36338.2 4988.0 4561.8     26    0.107   0      0.000    0.107
 0.0   1024.0  0.0   1024.0 659456.0 401408.0  388096.0   21727.5   38216.0 36338.5 4988.0 4561.8     27    0.109   0      0.000    0.109
 0.0   1024.0  0.0   1024.0 659456.0 203776.0  388096.0   21774.8   38216.0 36338.5 4988.0 4561.8     28    0.110   0      0.000    0.110
 0.0   1024.0  0.0   1024.0 659456.0 47104.0   388096.0   21775.2   38216.0 36354.0 4988.0 4561.8     29    0.111   0      0.000    0.111
 0.0   1024.0  0.0   1024.0 659456.0 525312.0  388096.0   21775.2   38216.0 36354.0 4988.0 4561.8     29    0.111   0      0.000    0.111
 0.0   1024.0  0.0   1024.0 659456.0 395264.0  388096.0   21762.3   38216.0 36355.2 4988.0 4561.8     30    0.113   0      0.000    0.113
 0.0   1024.0  0.0   1024.0 659456.0 238592.0  388096.0   21751.0   38216.0 36355.2 4988.0 4561.8     31    0.114   0      0.000    0.114
 0.0   1024.0  0.0   1024.0 659456.0 89088.0   388096.0   21760.1   38216.0 36355.2 4988.0 4561.8     32    0.117   0      0.000    0.117

```

- survivor 区占用的堆内存逐渐减少
- eden区占用的堆内存逐渐增大
- old区占用的堆内存也逐渐减少
- 最终各个分区占用的堆内存趋于稳定

从各分区的堆内存占用可以预测当前场景有大量新对象产生,但是存活下来的对象很少,可能是大量的局部变量创建,且并没有被GC Roots 引用
